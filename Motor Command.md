# RS485 步进电机控制器指令编辑指南 (Modbus-RTU)

本指南旨在帮助开发人员快速掌握该步进电机控制器的指令编写方法。该控制器基于 **RS485** 通信接口，遵循标准 **Modbus-RTU** 协议。

---

## 1. 快速上手：通信参数设置
在发送指令前，请确保上位机（电脑/PLC/单片机）的串口设置与设备一致。

*   **通信协议**：Modbus-RTU
*   **默认波特率**：**9600 bps** (对应寄存器值 3)
*   **数据位**：8
*   **停止位**：1
*   **校验位**：None (无校验)
*   **默认设备地址**：`0x01`
*   **通用广播地址**：`0xFE` (用于未知地址时控制，或多机同步，**注意：修改地址/波特率时总线只能接一台设备**)

---

## 2. 核心控制逻辑 (发送顺序)
要控制电机运行，建议遵循以下逻辑顺序。**注意：参数设置指令(1-3)不分先后，设置好后发送“运行”指令即可。**

1.  **设置速度**：设定电机转速 (RPM)。
2.  **设置行程**：设定电机要走多远 (圈数、角度、脉冲 三选一)。
    *   *换算关系*：1圈 = 360度 = 1600脉冲。
    *   *无限运行*：若将行程设为 `0`，电机将一直转动直到收到停止指令。
3.  **设置方向**：设定正转或反转。
4.  **发送“运行”指令**：启动电机。

> **提示**：参数具有记忆功能。若下一次运行的速度、行程、方向与上次相同，无需重复发送步骤1-3，直接发送“运行”指令即可。

---

## 3. 指令帧结构 (语法)
一条标准的 Modbus-RTU 指令包含 **8个字节**。所有数据均为 **十六进制 (HEX)**。

### 3.1 写指令 (功能码 06)
用于控制电机动作或修改参数。
> **格式**：`设备地址` + `06` + `寄存器高位` + `寄存器低位` + `数据高位` + `数据低位` + `CRC低` + `CRC高`

### 3.2 读指令 (功能码 03)
用于查询电机状态或当前参数。
> **格式**：`设备地址` + `03` + `寄存器高位` + `寄存器低位` + `读取数量高` + `读取数量低` + `CRC低` + `CRC高`

*(注：CRC校验码需通过CRC-16-MODBUS算法计算，最后两位必须正确设备才会响应)*

---

## 4. 寄存器功能对照表 (字典)
编写指令时，请查阅下表确定“寄存器地址”和“写入数据”。

### A. 运动控制 (最常用)
| 寄存器地址 (HEX) | 功能名称 | 数据范围/说明 |
| :--- | :--- | :--- |
| **0x01** | **运行方向** | `1`: 正转 <br> `0`: 反转 |
| **0x02** | **运行/暂停** | `1`: **运行** (启动电机) <br> `0`: 暂停 (电机停止，**保留**未完成行程，再次运行时继续走) |
| **0x03** | **停止** | `1`: 停止 (电机停止，**清除**行程，再次运行时从头开始) |
| **0x04** | **速度设置** | `1 - 800` (单位: r/min) |

### B. 行程设置 (三选一)
| 寄存器地址 (HEX) | 功能名称 | 数据范围/说明 |
| :--- | :--- | :--- |
| **0x05** | 脉冲数 | `0 - 65535` (设为0则一直转) |
| **0x06** | 圈数 | `0 - 65535` (设为0则一直转) |
| **0x07** | 角度 | `0 - 65535` (设为0则一直转) |

### C. 高级功能配置
| 寄存器地址 (HEX) | 功能名称 | 数据范围/说明 |
| :--- | :--- | :--- |
| **0x09** | 脱机使能 | `1`: 脱机 (电机无力矩，可用手转动) <br> `0`: 锁定 |
| **0x0A** | 一键回原点 | 写入 `1` 触发回到原点 |
| **0x0B** | 上电回原点 | `1`: 开启 (开机自动找原点) <br> `0`: 关闭 |
| **0x0D** | 启用限位 | `1`: 开启 (碰到限位开关自动停) <br> `0`: 关闭 |
| **0x0E** | 加减速系数 | `0 - 10` (0:无加减速; 10:加减速最快; **建议设置以防堵转**) |
| **0x15** | 设置原点 | 写入 `1` 设置当前位置为原点 |
| **0x1A** | 回原点速度 | `1 - 800` (单位: r/min)，读取/设置回原点速度 |

### E. 状态读取
| 寄存器地址 (HEX) | 功能名称 | 数据范围/说明 |
| :--- | :--- | :--- |
| **0x16** | 读取运行角度 | 返回当前运行角度值 (2字节) |
| **0x18** | 读取运行脉冲数 | 返回当前运行脉冲数 (4字节) |

### D. 系统通信设置
| 寄存器地址 (HEX) | 功能名称 | 数据范围/说明 |
| :--- | :--- | :--- |
| **0x08** | 修改设备地址 | `1 - 247` (默认1) |
| **0x0F** | 修改波特率 | `0`:1200 ... `3`:9600 ... `7`:115200 (详见图2) |

---

## 5. 常用指令实战举例
假设设备地址为默认的 `01`。请注意 CRC 校验码需根据实际计算。

### 场景一：让电机以 100 RPM 正转 2 圈

1.  **设速度 100** (100的十六进制是 0064)
    *   发送：`01 06 00 04 00 64 [CRC低] [CRC高]`
2.  **设圈数 2**
    *   发送：`01 06 00 06 00 02 [CRC低] [CRC高]`
3.  **设方向 正转**
    *   发送：`01 06 00 01 00 01 [CRC低] [CRC高]`
4.  **执行 运行**
    *   发送：`01 06 00 02 00 01 [CRC低] [CRC高]`

### 场景二：查询当前状态
*   **查询速度** (读寄存器 0x04)
    *   发送：`01 03 00 04 00 01 C5 CB`
*   **查询是否运行中** (读寄存器 0x02)
    *   发送：`01 03 00 02 00 01 25 CA`

### 场景三：修改设备地址 (例如改为 2号)
*   **注意**：建议使用广播地址 `FE` 修改，且总线上只连接这一台设备。
*   发送：`FE 06 00 08 00 02 [CRC校验]`

### 场景四：设置当前位置为原点
*   发送：`01 06 00 15 00 01 [CRC低] [CRC高]`

### 场景五：读取运行状态
*   **读取运行角度** (读寄存器 0x16)
    *   发送：`01 03 00 16 00 01 [CRC低] [CRC高]`
    *   接收：`01 03 02 [角度数据高] [角度数据低] [CRC低] [CRC高]`
*   **读取运行脉冲数** (读寄存器 0x18)
    *   发送：`01 03 00 18 00 02 [CRC低] [CRC高]`
    *   接收：`01 03 04 [脉冲数据字节3] [脉冲数据字节2] [脉冲数据字节1] [脉冲数据字节0] [CRC低] [CRC高]`

### 场景六：回到原点
*   **注意**：一键回原点功能，电机将自动回到设定的原点位置。
*   发送：`01 06 00 0A 00 01 [CRC低] [CRC高]`
*   接收：`01 06 00 0A 00 01 [CRC低] [CRC高]`

### 场景七：读取回原点速度
*   **读取回原点速度** (读寄存器 0x1A)
    *   发送：`01 03 00 1A 00 01 [CRC低] [CRC高]`
    *   接收：`01 03 02 [速度数据高] [速度数据低] [CRC低] [CRC高]`

### 场景八：设置回原点速度
*   **设置回原点速度** (写寄存器 0x1A)
    *   发送：`01 06 00 1A [速度数据高] [速度数据低] [CRC低] [CRC高]`
    *   接收：`01 06 00 1A [速度数据高] [速度数据低] [CRC低] [CRC高]`

---

## 6. 常见问题排查
1.  **电机不转，有电流声**：可能是速度过快或负载过大导致堵转。尝试调低速度，或增大“加减速系数(0x0E)”。
2.  **指令无响应**：
    *   检查波特率是否为 9600。
    *   检查设备地址是否正确（不确定可用 `FE` 广播地址测试）。
    *   检查 CRC 校验码计算是否正确（高低位是否颠倒）。
3.  **暂停与停止的区别**：
    *   **暂停**后由“运行”恢复，会把之前没走完的路走完。
    *   **停止**后由“运行”恢复，会忽略之前的进度，重新开始新的行程。